#!/bin/bash

# SMTP Configuration
SMTP_HOST="smtp.com"
SMTP_PORT=25
MAIL_FROM="no-reply.jenkins@com"
MAIL_TO="anouar@scom"

# Read inputs
jobResults="$1"
account="$2"

account=$(echo "$account" | tr '[:lower:]' '[:upper:]')
date_now=$(date '+%d/%m/%Y %H:%M')

# Function to format job details
format_job_results() {
    local json="$1"
    local formatted_jobs="<table style='width:100%; border-collapse: collapse;'>
        <tr style='background:#e68e0b; color:#ffffff; text-align:left;'>
            <th style='padding:8px;'>Job Path</th>
            <th style='padding:8px;'>Status</th>
            <th style='padding:8px;'>Build Number</th>
        </tr>"
    
    # Extract and format each job result
    while [[ "$json" =~ jobPath:([^,]+),\ status:([^,]+),\ buildNumber:([0-9]+) ]]; do
        job_path="${BASH_REMATCH[1]}"
        job_status="${BASH_REMATCH[2]}"
        build_number="${BASH_REMATCH[3]}"
        
        formatted_jobs+="<tr>
            <td style='padding:8px; border-bottom:1px solid #ddd;'>$job_path</td>
            <td style='padding:8px; border-bottom:1px solid #ddd;'>$job_status</td>
            <td style='padding:8px; border-bottom:1px solid #ddd;'>$build_number</td>
        </tr>"
        
        json=${json#*]} # Move past the matched job entry
    done

    formatted_jobs+="</table>"
    echo "$formatted_jobs"
}

# Generate HTML email
job_details=$(format_job_results "$jobResults")

email_content='<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jenkins Job Report</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 600px; background: #ffffff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px #ccc; }
        .header { background-color: #e68e0b; color: #fff; padding: 10px; text-align: center; font-size: 18px; font-weight: bold; border-radius: 5px 5px 0 0; }
        .content { padding: 15px; }
        .footer { text-align: center; font-size: 12px; color: #555; padding: 10px; }
        .highlight { font-weight: bold; color: #e68e0b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Jenkins Job Report - '"${account}"'</div>
        <div class="content">
            <p><strong>ðŸ“… Date:</strong> '"${date_now}"' GMT+1</p>
            <p><strong>ðŸ‘¤ Account:</strong> '"${account}"'</p>
            <h3>Job Execution Summary:</h3>
            '"${job_details}"'
        </div>
        <div class="footer">This is an automated email from the DevOps team. Do not reply.</div>
    </div>
</body>
</html>'

# Send email
temp_file=$(mktemp)
echo -e "Subject: Jenkins Job Report - ${account}\nContent-Type: text/html; charset=UTF-8\n\n${email_content}" > "$temp_file"

curl -s --url "smtp://${SMTP_HOST}:${SMTP_PORT}" --mail-from "${MAIL_FROM}" --mail-rcpt "${MAIL_TO}" --upload-file "$temp_file"

rm -f "$temp_file"