- name: Configure SSL for Apache HTTPD
  hosts: webservers
  become: yes
  vars:
    ssl_cert_src: "/app/products/proxy/host.pem"
    ssl_key_src: "/app/products/proxy/host.key"
    ssl_dir: "/etc/httpd/ssl"
    ssl_conf_file: "/etc/httpd/conf.d/ssl.conf"

  tasks:
    - name: Install Apache and mod_ssl
      yum:
        name:
          - httpd
          - mod_ssl
        state: present

    - name: Create SSL directory
      file:
        path: "{{ ssl_dir }}"
        state: directory
        mode: '0755'

    - name: Copy SSL certificate
      copy:
        src: "{{ ssl_cert_src }}"
        dest: "{{ ssl_dir }}/server.crt"
        owner: root
        group: root
        mode: '0600'

    - name: Copy SSL private key
      copy:
        src: "{{ ssl_key_src }}"
        dest: "{{ ssl_dir }}/server.key"
        owner: root
        group: root
        mode: '0600'

    - name: Configure SSL VirtualHost
      blockinfile:
        path: "{{ ssl_conf_file }}"
        marker: "# {mark} SSL CONFIGURATION"
        block: |
          <VirtualHost *:443>
              ServerName example.com
              DocumentRoot /var/www/html

              SSLEngine on
              SSLCertificateFile {{ ssl_dir }}/server.crt
              SSLCertificateKeyFile {{ ssl_dir }}/server.key

              <Directory "/var/www/html">
                  AllowOverride All
                  Require all granted
              </Directory>

              ErrorLog /var/log/httpd/ssl_error_log
              CustomLog /var/log/httpd/ssl_access_log combined
          </VirtualHost>

    - name: Restart Apache HTTPD
      service:
        name: httpd
        state: restarted
        enabled: yes