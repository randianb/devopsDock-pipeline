#!/bin/bash

# SMTP Configuration
SMTP_HOST="smtp-goss.int.world.socgen"
SMTP_PORT=25
MAIL_FROM="devops.monitoring@socgen.com"
MAIL_TO="anouar.harrou@socgen.com"

# Read server details
server_name="$1"
account="$2"
mismatch_details="$3"

# Function to send an email notification
send_email() {
    local subject="🚨 Critical Alert: Image Mismatch on ${server_name} (Account: ${account})"
    local message="<html>
    <body style='font-family:Arial, sans-serif; background-color:#f4f4f4; padding:20px; text-align:center;'>
        <div style='max-width:600px; margin:auto; background:#ffffff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); text-align:center;'>
            <h2 style='color:#d9534f;'>🚨 Image Mismatch Detected</h2>
            <p style='font-size:16px; color:#333;'>An inconsistency has been detected in the image versions on the specified server.</p>
            <hr style='border:0; height:1px; background:#ddd;'>
            <table style='width:80%; margin:auto; font-size:16px; border-collapse:collapse;'>
                <tr style='background:#f8f9fa;'>
                    <td style='padding:10px; font-weight:bold; color:#0275d8;'>👤 Account:</td>
                    <td style='padding:10px;'>${account}</td>
                </tr>
                <tr style='background:#f8f9fa;'>
                    <td style='padding:10px; font-weight:bold; color:#0275d8;'>🖥️ Server:</td>
                    <td style='padding:10px;'>${server_name}</td>
                </tr>
            </table>
            <h3 style='color:#d9534f; margin-top:20px;'>⚠️ Mismatch Details:</h3>
            <div style='text-align:center;'>
                <pre style='background:#f8f9fa; padding:15px; border-left:4px solid #d9534f; font-size:14px; display:inline-block; text-align:left;'>${mismatch_details}</pre>
            </div>
            <p style='font-size:14px; color:#333;'>🔍 Please review the details and take the necessary actions.</p>
            <hr style='border:0; height:1px; background:#ddd;'>
            <p style='color:#5e5e5e; font-size:12px;'>📧 This is an automated notification from the DevOps monitoring system.</p>
        </div>
    </body></html>"

    local temp_file=$(mktemp)

    echo -e "Subject: ${subject}\nContent-Type: text/html; charset=UTF-8\n\n${message}" > "${temp_file}"

    curl -s --url "smtp://${SMTP_HOST}:${SMTP_PORT}" --mail-from "${MAIL_FROM}" --mail-rcpt "${MAIL_TO}" --upload-file "${temp_file}"

    rm -f "${temp_file}"
}

# Execute the email function
send_email