---
# Copy static folders (CRONS, LOGS) to the target system
- name: Copy CRONS and LOGS folders to target
  copy:
    src: WSO2_DB_CLEANUP/
    dest: /home/cloud-user/WSO2_DB_CLEANUP/
    owner: cloud-user
    group: cloud-user
    mode: '0755'
  with_items:
    - CRONS
    - LOGS
  loop_control:
    loop_var: folder

# Replace sensitive variables in scripts using templates
- name: Copy SCRIPTS with sensitive variables replaced
  template:
    src: "WSO2_DB_CLEANUP/SCRIPTS/{{ item }}.j2"
    dest: "/home/cloud-user/WSO2_DB_CLEANUP/SCRIPTS/{{ item }}"
    owner: cloud-user
    group: cloud-user
    mode: '0755'
  with_items:
    - script-session-data-cleanup-runner.sh
    - script-stop-process-session-data-cleanup-ruuner.sh
    - script-stop-process-token-cleanup-runner.sh
    - script-token-cleanup-runner.sh

# Set up crontab for cleanup tasks
- name: Set up crontab for cloud-user
  cron:
    name: "{{ item.name }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    job: "{{ item.job }}"
    user: cloud-user
  loop:
    - { name: "Token Cleanup Runner", minute: "0", hour: "1", job: "/bin/sh /home/cloud-user/WSO2_DB_CLEANUP/CRONS/cron_token_cleanup_runner.sh" }
    - { name: "Session Data Cleanup Runner", minute: "0", hour: "1", job: "/bin/sh /home/cloud-user/WSO2_DB_CLEANUP/CRONS/cron_session_data_cleanup_runner.sh" }
    - { name: "Stop Process Session Data Cleanup", minute: "0", hour: "4", job: "/bin/sh /home/cloud-user/WSO2_DB_CLEANUP/CRONS/cron-stop-process-session-data-cleanup-ruuner.sh" }
    - { name: "Stop Process Token Cleanup", minute: "0", hour: "4", job: "/bin/sh /home/cloud-user/WSO2_DB_CLEANUP/CRONS/cron-stop-process-token-cleanup-runner.sh" }

# Disable SELinux temporarily
- name: Disable SELinux temporarily
  command: setenforce 0
  when: ansible_selinux.status == "enabled"

# Ensure SELinux is permissive in the config
- name: Ensure SELinux is permissive in config
  lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: 'SELINUX=permissive'
    state: present



###structure 
roles/
├── WSO2_DB_CLEANUP/
│   ├── tasks/
│   │   └── main.yml
│   ├── templates/
│   │   └── WSO2_DB_CLEANUP/
│   │       └── SCRIPTS/
│   │           ├── script-session-data-cleanup-runner.sh.j2
│   │           ├── script-stop-process-session-data-cleanup-ruuner.sh.j2
│   │           ├── script-stop-process-token-cleanup-runner.sh.j2
│   │           └── script-token-cleanup-runner.sh.j2
│   ├── files/
│   │   └── WSO2_DB_CLEANUP/
│   │       ├── CRONS/
│   │       │   ├── cron_session_data_cleanup_runner.sh
│   │       │   ├── cron-stop-process-session-data-cleanup-ruuner.sh
│   │       │   ├── cron-stop-process-token-cleanup-runner.sh
│   │       │   └── cron_token_cleanup_runner.sh
│   │       ├── LOGS/
│   │       └── (empty directories or placeholder files)
│   └── meta/
│       └── main.yml