#!/bin/bash

# SMTP Configuration
SMTP_HOST="smtp-goss.int.world.socgen"
SMTP_PORT=25
MAIL_FROM="devops.monitoring@socgen.com"
MAIL_TO="anouar.harrou@socgen.com"

# Read server details
server_name="$1"
account="$2"
mismatch_details="$3"

# Function to send an email notification
send_email() {
    local subject="üö® Critical Alert: Image Mismatch on ${server_name} (Account: ${account})"
    local message="<!DOCTYPE html><html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>[DEVOPS] [SGABS] : Mismatch Alerts ** Sous Surveillance **</title>
            <style>
                body {
                    background-color: #fcfeff;
                    font-family: Calibri, NotoSans, Roboto, Arial, sans-serif;
                    font-size: 14px;
                    line-height: 1.4;
                    margin: 0;
                    padding: 0;
                    min-width: 300px;
                }
                .container {
                    width: 580px;
                    max-width: 580px;
                    margin: 0 auto;
                    background-color: #ffffff;
                    border-radius: 4px;
                    border: 1px solid #01b289;
                }
                .header {
                    background-color: #01b289;
                    color: #ffffff;
                    text-align: center;
                    font-size: 24px;
                    border-top-left-radius: 4px;
                    border-top-right-radius: 4px;
                    padding: 10px;
                }
                .title {
                    text-align: center;
                    font-size: 20px;
                    font-weight: bold;
                    margin: 15px 0;
                }
                .sub-header {
                    padding: 10px;
                    font-size: 16px;
                    font-weight: bold;
                }
                .info-table {
                    width: 100%;
                    font-size: 13px;
                    margin: 10px 0;
                }
                .info-table td {
                    padding: 5px 15px;
                }
                .summary {
                    background-color: #01b289;
                    color: #ffffff;
                    font-size: 20px;
                    padding: 10px;
                }
                .description, .root-cause, .solution {
                    padding: 10px 15px;
                    font-size: 13px;
                }
                .footer {
                    font-size: 12px;
                    text-align: center;
                    padding: 10px;
                    color: #555;
                }
            </style>
        </head>
        <body>
            <table width="100%" align="center">
                <tr>
                    <td align="center">
                        <div class="container">
                            <div class="header">Vulnerable OS Factory Patching Script</div>
                            <div class="title">[DEVOPS][SGABS][OS FACTORY]: Critical Alert: Image Mismatch on ${server_name} (Account: ${account})</div>
                            <div class="sub-header">DEVOPS Vulnerable Control</div>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Date</strong></td>
                                    <td>25/02/2025 √† 08:00</td>
                                </tr>
                            </table>
                            <table class="info-table">
                                <tr>
                                    <td>üë§ Account:</td>
                                    <td>${account}</td>
                                </tr>
                                <tr>
                                    <td>üñ•Ô∏è Server:</td>
                                    <td>${server_name}</td>
                                </tr>
                            </table>
                            <div class="summary">‚ö†Ô∏è Mismatch Details:</div>
                            <div class="description">
                                <pre>${mismatch_details}</pre>
                            </div>
                            <div class="solution">
                                <strong>Solution:</strong>
                                <p>üîç Please review the details and take the necessary actions.</p>
                            </div>
                            <div class="footer">¬© 2025 - Tous droits r√©serv√©s.</div>
                        </div>
                    </td>
                </tr>
            </table>
        </body>
        </html>"

    local temp_file=$(mktemp)

    echo -e "Subject: ${subject}\nContent-Type: text/html; charset=UTF-8\n\n${message}" > "${temp_file}"

    curl -s --url "smtp://${SMTP_HOST}:${SMTP_PORT}" --mail-from "${MAIL_FROM}" --mail-rcpt "${MAIL_TO}" --upload-file "${temp_file}"

    rm -f "${temp_file}"
}

# Execute the email function
send_email
