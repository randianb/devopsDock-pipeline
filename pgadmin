import sys

def get_server_image_id(self, server_name, retry=3):
    access_token = self.get_iam_token(["ccs:read:all"])
    try:
        url = f"{OCS_SERVERS_ENDPOINT}?status=ACTIVE&name={server_name}"
        logger.debug(f"Request URL: {url}")

        res = http_client.get(
            url,
            headers={
                "accept": "application/json",
                "Authorization": f"Bearer {access_token}"
            }
        )

        # Force print and flush to ensure output appears in Jenkins logs
        print("\nRaw API Response:", file=sys.stdout, flush=True)
        print(res.text, file=sys.stdout, flush=True)  

        if res.status_code != 200 and retry > 0:
            logger.warning(f"Retrying API request, attempts left: {retry}")
            time.sleep(2)
            return self.get_server_image_id(server_name, retry=retry - 1)

        if res.status_code != 200:
            logger.error(f"Failed to retrieve server details: {res.text}")
            raise Exception("Failed to retrieve server details")

        data = res.json()
        logger.debug(f"API Response: {data}")

        if "servers" not in data or not data["servers"]:
            print(f"DEBUG: No servers found in API response for {server_name}", file=sys.stdout, flush=True)
            raise Exception(f"No servers found for name: {server_name}")

        print("\nParsed API Response:", file=sys.stdout, flush=True)
        for i, server in enumerate(data["servers"]):
            print(f"Server {i}: {server}", file=sys.stdout, flush=True)

        matching_servers = [server for server in data["servers"] if server_name.lower() in server["name"].lower()]

        if not matching_servers:
            print(f"DEBUG: No matching server found for {server_name}", file=sys.stdout, flush=True)
            raise Exception(f"No matching server found for name: {server_name}")

        server_data = matching_servers[0]
        logger.debug(f"Selected server data: {server_data}")

        if "image" in server_data:
            image_id = server_data["image"]["id"]
            logger.debug(f"Retrieved image ID: {image_id}")
            return image_id
        else:
            logger.error(f"Image ID not found in server data: {server_data}")
            raise KeyError("image")

    except Exception as e:
        logger.error(f"Error in get_server_image_id: {e}")
        raise