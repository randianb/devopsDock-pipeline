
ARTIFACT_VERSION=$(curl -s https://itbox-nexus-arc.fr.world.socgen/nexus-arc/repository/sgcib-sgabs-maven2-hosted-snapshots/com/socgen/unibank/services/unibank-service-branch-onboarding/{{ version }}/maven-metadata.xml | grep -A 1 "<extension>jar</extension>" | grep "<value>" | sed -E 's/.*<value>(.*)<\/value>.*/\1/')

ARTIFACT_URL="http://your-nexus-server/repository/snapshots/com/socgen/unibank/services/unibank-service-branch-onboarding/{{ version }}/unibank-service-branch-onboarding-${ARTIFACT_VERSION}.jar"

- block:
    - name: Fetch artifact version from maven-metadata.xml
      command: >
        curl -s "http://your-nexus-server/repository/sgcib-sgabs-maven2-hosted-snapshots/com/socgen/unibank/services/unibank-service-branch-onboarding/{{ version }}/maven-metadata.xml"
        | grep -A 1 "<extension>jar</extension>"
        | grep "<value>"
        | sed -E 's/.*<value>(.*)<\/value>.*/\1/'
      register: artifact_version

    - name: Set artifact version fact
      set_fact:
        artifact_version: "{{ artifact_version.stdout }}"

    - name: Construct artifact URL
      set_fact:
        artifact_url: "http://your-nexus-server/repository/sgcib-sgabs-maven2-hosted-snapshots/com/socgen/unibank/services/unibank-service-branch-onboarding/{{ version }}/unibank-service-branch-onboarding-{{ artifact_version }}.jar"

    - name: Download the latest snapshot artifact
      get_url:
        url: "{{ artifact_url }}"
        dest: "/tmp/unibank-service-branch-onboarding-{{ artifact_version }}.jar"

    - name: Confirm artifact download
      stat:
        path: "/tmp/unibank-service-branch-onboarding-{{ artifact_version }}.jar"
      register: artifact_file

    - name: Display confirmation message
      debug:
        msg: "Artifact downloaded successfully: {{ artifact_file.stat.path }}"
      when: artifact_file.stat.exists

  when: version_type == "snapshots"
