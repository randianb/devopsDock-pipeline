#!/bin/bash

# SMTP Configuration
SMTP_HOST="smtp-goss.int.world.socgen"
SMTP_PORT=25
MAIL_FROM="devops.monitoring@socgen.com"
MAIL_TO="anouar.harrou@socgen.com"

# Read server details
server_name="$1"
account="$2"
mismatch_details="$3"
date_now=$(date '+%d/%m/%Y √† %H:%M')

# Create email content
temp_file=$(mktemp)

printf "From: %s\nTo: %s\nSubject: üö® Critical Alert: Image Mismatch on %s (Account: %s)\nMIME-Version: 1.0\nContent-Type: text/html; charset=UTF-8\n\n" "$MAIL_FROM" "$MAIL_TO" "$server_name" "$account" > "$temp_file"

cat <<EOF >> "$temp_file"
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[DEVOPS] [SGABS] : Mismatch Alerts ** Sous Surveillance **</title>
    <style>
        body {background-color: #fcfeff; font-family: Calibri, Arial, sans-serif; font-size: 14px; line-height: 1.4; margin: 0; padding: 0;}
        .container {width: 580px; max-width: 580px; margin: 0 auto; background-color: #ffffff; border-radius: 4px; border: 1px solid #e68e0b;}
        .header {background-color: #e68e0b; color: #ffffff; text-align: center; font-size: 24px; border-radius: 4px 4px 0 0; padding: 10px;}
        .title {text-align: center; font-size: 20px; font-weight: bold; margin: 15px 0;}
        .info-table {width: 100%; font-size: 13px; margin: 10px 0;}
        .info-table td {padding: 5px 15px;}
        .summary {background-color: #e68e0b; color: #ffffff; font-size: 20px; padding: 10px;}
        .description {padding: 10px 15px; font-size: 13px; white-space: pre-wrap; word-wrap: break-word;}
        .footer {font-size: 12px; text-align: center; padding: 10px; color: #555;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Vulnerable OS Factory Patching Script</div>
        <div class="title">[DEVOPS][SGABS][OS FACTORY]: Critical Alert: Image Mismatch on ${server_name} (Account: ${account})</div>
        <table class="info-table">
            <tr><td><strong>Date:</strong></td><td>${date_now}</td></tr>
            <tr><td>üë§ Account:</td><td>${account}</td></tr>
            <tr><td>üñ•Ô∏è Server:</td><td>${server_name}</td></tr>
        </table>
        <div class="summary">‚ö†Ô∏è Mismatch Details:</div>
        <div class="description">${mismatch_details}</div>
        <div class="footer">¬© 2025 - Tous droits r√©serv√©s.</div>
    </div>
</body>
</html>
EOF

# Send email using curl with optimized settings
curl --max-time 10 --connect-timeout 5 -s --url "smtp://${SMTP_HOST}:${SMTP_PORT}" \
     --mail-from "${MAIL_FROM}" --mail-rcpt "${MAIL_TO}" --upload-file "${temp_file}"

# Clean up temp file
rm -f "${temp_file}"