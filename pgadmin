import sys
import json

def parse_list(arg):
    try:
        return json.loads(arg.replace("'", '"'))
    except json.JSONDecodeError:
        print(f"Error: Invalid list format -> {arg}")
        sys.exit(1)

def main():
    if len(sys.argv) < 7:
        print("Usage: compare_latest_ocs_images.py <LATEST_OS_IMAGE_paris> <LATEST_OS_IMAGE_north> <LIST_OS_IMAGE_paris> <LIST_OS_IMAGE_north> <IMAGE_INSTALLED_paris> <IMAGE_INSTALLED_north>")
        sys.exit(1)

    latest_os_paris = sys.argv[1]
    latest_os_north = sys.argv[2]
    list_os_paris = parse_list(sys.argv[3])
    list_os_north = parse_list(sys.argv[4])
    image_installed_paris = sys.argv[5]
    image_installed_north = sys.argv[6]

    # Step 1: Determine the common latest OS image
    if latest_os_paris == latest_os_north:
        os_factory = latest_os_paris
        print(f"Both regions have the same latest OS image: {os_factory}")
    else:
        common_images = sorted(set(list_os_paris) & set(list_os_north), reverse=True)
        if common_images:
            os_factory = common_images[0]
            print(f"The latest OS in Paris ({latest_os_paris}) differs from North ({latest_os_north}). The latest common image is: {os_factory}")
        else:
            print(f"No common OS image found between Paris and North.")
            sys.exit(1)  # Exit since there's no common image to proceed with

    # Step 2: Check if installed images match the latest common OS
    deployment_needed = False
    final_os_factory = os_factory  # Default to the latest common OS

    if image_installed_paris == os_factory:
        print(f"The latest common image is already installed in Paris: {image_installed_paris}")
    else:
        print(f"The latest common image ({os_factory}) is NOT installed in Paris (Installed: {image_installed_paris}). It must be updated.")
        deployment_needed = True

    if image_installed_north == os_factory:
        print(f"The latest common image is already installed in North: {image_installed_north}")
    else:
        print(f"The latest common image ({os_factory}) is NOT installed in North (Installed: {image_installed_north}). It must be updated.")
        deployment_needed = True

    if deployment_needed:
        print(f"Deployment required. Use this OS image: {final_os_factory}")
    else:
        print("No deployment needed.")

if __name__ == "__main__":
    main()