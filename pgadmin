---
- name: Install development tools and dependencies
  yum:
    name:
      - '@Development Tools'
      - python3-devel
      - postgresql-devel
    state: present

- name: Download psycopg2 tarball
  get_url:
    url: "{{ psycopg2_tarball_url }}"
    dest: /tmp/psycopg2-{{ psycopg2_version }}.tar.gz

- name: Extract psycopg2 tarball
  unarchive:
    src: /tmp/psycopg2-{{ psycopg2_version }}.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Build psycopg2
  command: python{{ python_version }} setup.py build
  args:
    chdir: /tmp/psycopg2-{{ psycopg2_version }}

- name: Install psycopg2
  command: python{{ python_version }} setup.py install
  args:
    chdir: /tmp/psycopg2-{{ psycopg2_version }}

- name: Update PYTHONPATH environment variable
  lineinfile:
    path: /etc/environment
    line: "PYTHONPATH=/usr/local/lib64/python{{ python_version }}/site-packages/:$PYTHONPATH"
    create: yes

- name: Reload environment variables
  shell: source /etc/environment
  args:
    executable: /bin/bash

- name: Verify installed Python packages
  shell: pip list
  register: pip_output

- name: Display pip list output
  debug:
    var: pip_output.stdout



###vars/main.yml
---
python_version: "3.9"
psycopg2_version: "2.9.10"
psycopg2_tarball_url: "https://objs3parstd01.fr.world.socgen/xsf-af567-prd-artifacts/public/python/psycopg2-2.9.10.tar.gz"