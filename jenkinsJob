def jenkinsUrl = "https://cdp-jenkins-paas-xsf.fr.world.socgen"

pipeline {
    agent any

    stages {
        stage('Get Last Success Build') {
            steps {
                withCredentials([
                    string(credentialsId: 'jenkins-user', variable: 'JENKINS_USER'),
                    string(credentialsId: 'jenkins-token', variable: 'JENKINS_TOKEN')
                ]) {
                    script {
                        // Get the last successful build number
                        def buildNumber = sh(
                            script: """curl -s --user \${JENKINS_USER}:\${JENKINS_TOKEN} \\
                            '${jenkinsUrl}/job/DJD/job/CD-Deploy/job/openr-pipeline-int/lastSuccessfulBuild/buildNumber'""",
                            returnStdout: true
                        ).trim()

                        echo "Latest Successful Build Number: ${buildNumber}"

                        // Trigger the replay
                        def replayResponse = sh(
                            script: """curl -s -X POST --user \${JENKINS_USER}:\${JENKINS_TOKEN} \\
                            '${jenkinsUrl}/job/DJD/job/CD-Deploy/job/openr-pipeline-int/${buildNumber}/replay/run'""",
                            returnStdout: true
                        ).trim()

                        echo "Replay Response: ${replayResponse}"
                    }
                }
            }
        }
    }
}
